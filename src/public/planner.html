<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EcoBite • Meal Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --ok:#10b981; --warn:#d97706;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    header{background:url("https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1600&auto=format&fit=crop") center/cover no-repeat;position:relative;padding:56px 20px;color:#fff}
    header::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .hero{position:relative;z-index:1;max-width:1100px;margin:0 auto;display:flex;align-items:flex-end;justify-content:space-between;gap:16px}
    .hero h1{margin:0;font-size:34px;font-weight:900}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.light{background:#fff;color:#111}
    .btn.ghost{background:transparent;border:2px solid #fff;color:#fff}

    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:280px 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.05)}
    .muted{color:var(--muted)}

    /* sidebar */
    .sidebar h3{margin:0 0 10px}
    .inv-list{display:grid;gap:8px;max-height:60vh;overflow:auto}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .chip small{color:var(--muted)}
    .chip[draggable="true"]{cursor:grab}

    /* planner grid */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:#e5e7eb;color:#111}

    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .col{display:grid;grid-template-rows:auto 1fr;gap:8px}
    .col h4{margin:0;font-size:14px;color:#374151}
    .cell{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;min-height:120px;background:#fff}
    .slot{border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;margin:6px 0;background:#f8fafc;display:flex;justify-content:space-between;align-items:center}
    .slot .del{background:#fee2e2;color:#991b1b;border:none;border-radius:6px;padding:4px 6px;cursor:pointer}
    .empty{color:#9ca3af;font-size:12px}

    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:800;font-size:12px}
    @media(max-width: 980px){ main{grid-template-columns:1fr} .grid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div>
        <h1>Meal Planner</h1>
        <div class="muted">Drag ingredients from inventory to plan your week.</div>
      </div>
      <div>
        <button class="btn light" onclick="goHome()">← Home</button>
        <button class="btn light" onclick="goInventory()">Inventory</button>
        <button class="btn ghost" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <!-- 左侧：库存可拖拽 -->
    <section class="card sidebar">
      <div class="toolbar">
        <input id="week" type="date" />
        <button class="btn secondary" onclick="thisWeek()">This Week</button>
        <button class="btn primary" onclick="savePlan()">Save</button>
        <button class="btn secondary" onclick="clearPlan()">Clear</button>
        <button class="btn secondary" onclick="exportJSON()">Export JSON</button>
      </div>
      <h3>Inventory</h3>
      <div class="inv-list" id="invList"></div>
      <div class="muted" style="margin-top:8px">* 临期与过期食材会高亮，建议优先使用。</div>
    </section>

    <!-- 右侧：周计划 7 × 3 -->
    <section class="card">
      <div class="footer">
        <div>Week of <span class="badge" id="weekText"></span></div>
        <div class="muted">Slots: Breakfast / Lunch / Dinner</div>
      </div>
      <div class="grid" id="grid"></div>
    </section>
  </main>

<script>
/* ===== auth & nav ===== */
function getToken(){ return localStorage.getItem("token") || ""; }
function headersAuth(){ return { "Authorization":"Bearer "+getToken() }; }
if (!getToken()) location.href="/login.html";
function logout(){ localStorage.removeItem("token"); location.href="/login.html"; }
function goHome(){ location.href="/"; }
function goInventory(){ location.href="/index.html"; }

/* ===== state ===== */
let INVENTORY = [];
let PLAN = {}; // { 'YYYY-MM-DD': { breakfast:[], lunch:[], dinner:[] } }
const MEALS = ["breakfast","lunch","dinner"];
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

function userKey(){
  try{ const p = JSON.parse(atob(getToken().split(".")[1])); return p.email || "user"; }catch{ return "user"; }
}
function storeKey(date){ return `ecobite:${userKey()}:planner:${date}`; } // date 为周一

/* ===== utils ===== */
function startOfWeek(d){ // 周一为一周开始
  const dt = new Date(d); const day = (dt.getDay()+6)%7; // Mon=0
  dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0);
  return dt;
}
function addDays(d, n){ const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; }
function fmt(d){ return new Date(d).toISOString().slice(0,10); }

/* ===== load ===== */
async function refresh(){
  const res = await fetch("/inventory", { headers: headersAuth() });
  if (res.status === 401) { location.href="/login.html"; return; }
  INVENTORY = await res.json();
  renderInventory();
  renderGrid();
}

function renderInventory(){
  const host = document.getElementById("invList");
  host.innerHTML = "";
  const today = new Date(); today.setHours(0,0,0,0);
  for(const it of INVENTORY){
    const exp = new Date(it.expiry_date);
    const diff = Math.ceil((exp - today)/86400000);
    const highlight = it.status==="expired" ? "border:2px solid #ef4444" :
                      it.status==="near_expiry" ? "border:2px solid #d97706" : "";
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.draggable = true;
    chip.style = highlight;
    chip.dataset.payload = JSON.stringify({ id: it.id, name: it.name, qty: it.quantity, cat: it.category, exp: fmt(exp) });
    chip.innerHTML = `<span>${it.name} <small>×${it.quantity}</small></span><small>${it.category} • exp ${fmt(exp)}</small>`;
    chip.addEventListener("dragstart", onDragStart);
    host.appendChild(chip);
  }
}

function renderGrid(){
  const host = document.getElementById("grid"); host.innerHTML="";
  const weekStr = document.getElementById("week").value || fmt(startOfWeek(new Date()));
  const wk = startOfWeek(weekStr);
  document.getElementById("weekText").textContent = fmt(wk);

  // 载入本周计划
  const saved = localStorage.getItem(storeKey(fmt(wk)));
  PLAN = saved ? JSON.parse(saved) : {};

  for (let i=0;i<7;i++){
    const day = addDays(wk, i);
    const dateKey = fmt(day);
    const col = document.createElement("div");
    col.className = "col";
    col.innerHTML = `<h4>${DAYS[i]} <span class="muted">${dateKey}</span></h4>`;

    const cell = document.createElement("div");
    cell.className = "cell";
    cell.dataset.date = dateKey;
    cell.addEventListener("dragover", (e)=>e.preventDefault());
    cell.addEventListener("drop", onDropCell);

    // 三个餐次
    MEALS.forEach(meal=>{
      const list = (PLAN[dateKey]?.[meal]) || [];
      const section = document.createElement("div");
      section.className = "slot";
      section.dataset.date = dateKey;
      section.dataset.meal = meal;
      section.addEventListener("dragover", (e)=>e.preventDefault());
      section.addEventListener("drop", onDropSlot);
      section.innerHTML = `<div style="font-weight:700;text-transform:capitalize">${meal}</div>
        <div class="muted">${list.length? list.map(x=>x.name).join(", ") : "<span class='empty'>drop items here</span>"}</div>`;
      cell.appendChild(section);
    });

    col.appendChild(cell);
    host.appendChild(col);
  }
}

/* ===== drag & drop ===== */
function onDragStart(e){ e.dataTransfer.setData("text/plain", e.target.dataset.payload); }

function onDropCell(e){
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData("text/plain"));
  // 如果拖到整格，默认放到 lunch
  placeTo(e.currentTarget.dataset.date, "lunch", data);
}
function onDropSlot(e){
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData("text/plain"));
  placeTo(e.currentTarget.dataset.date, e.currentTarget.dataset.meal, data);
}

function placeTo(dateKey, meal, item){
  PLAN[dateKey] = PLAN[dateKey] || { breakfast:[], lunch:[], dinner:[] };
  PLAN[dateKey][meal].push({ id:item.id, name:item.name, exp:item.exp, cat:item.cat });
  renderGrid();
}

/* ===== actions ===== */
function thisWeek(){
  const monday = startOfWeek(new Date());
  document.getElementById("week").value = fmt(monday);
  renderGrid();
}
function savePlan(){
  const wk = fmt(startOfWeek(document.getElementById("week").value || new Date()));
  localStorage.setItem(storeKey(wk), JSON.stringify(PLAN));
  alert("Saved ✓");
}
function clearPlan(){
  if(!confirm("Clear current week plan?")) return;
  const wk = fmt(startOfWeek(document.getElementById("week").value || new Date()));
  PLAN = {};
  localStorage.removeItem(storeKey(wk));
  renderGrid();
}
function exportJSON(){
  const wk = fmt(startOfWeek(document.getElementById("week").value || new Date()));
  const blob = new Blob([JSON.stringify({ week:wk, plan:PLAN }, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `meal-plan-${wk}.json`;
  a.click();
}

/* ===== init ===== */
document.getElementById("week").value = fmt(startOfWeek(new Date()));
refresh();
</script>
</body>
</html>
